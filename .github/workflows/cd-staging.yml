name: CD - Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.REGISTRY_URL }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
      
      - name: Build and push backend image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.REGISTRY_URL }}/origin-backend:staging-${{ github.sha }}
            ${{ secrets.REGISTRY_URL }}/origin-backend:staging-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push Celery worker image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile.celery
          push: true
          tags: |
            ${{ secrets.REGISTRY_URL }}/origin-celery:staging-${{ github.sha }}
            ${{ secrets.REGISTRY_URL }}/origin-celery:staging-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push Celery beat image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile.celery-beat
          push: true
          tags: |
            ${{ secrets.REGISTRY_URL }}/origin-celery-beat:staging-${{ github.sha }}
            ${{ secrets.REGISTRY_URL }}/origin-celery-beat:staging-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Deploy to staging server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/origin-platform
            docker-compose -f docker-compose.staging.yml pull
            docker-compose -f docker-compose.staging.yml up -d
            docker-compose -f docker-compose.staging.yml exec -T backend alembic upgrade head
      
      - name: Run smoke tests
        run: |
          sleep 30
          curl -f ${{ secrets.STAGING_URL }}/health || exit 1
          curl -f ${{ secrets.STAGING_URL }}/health/detailed || exit 1
      
      - name: Notify deployment
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Staging deployment completed'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()
